#!/bin/bash

# ã‚¿ã‚°ãŒpushã•ã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯
while read local_ref local_sha remote_ref remote_sha
do
    if [[ $local_ref == refs/tags/* ]]; then
        TAG=${local_ref#refs/tags/}
        echo "ğŸ”„ Detected tag push: $TAG"

        # BSR push
        echo "ğŸ”„ Pushing to BSR..."
        buf push --label $TAG

        if [ $? -eq 0 ]; then
            echo "âœ… BSR push successful: $TAG"
        else
            echo "âš ï¸  BSR push failed (continuing with git push)"
            # exit 1 ã§git pushã‚’ä¸­æ­¢ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
        fi

        # Release binary build
        echo "ğŸ”„ Building release binary..."
        GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build \
          -o "etc_meisai_scraper-$TAG-windows-amd64.exe" \
          -ldflags="-s -w -X main.Version=$TAG" \
          .

        if [ $? -eq 0 ]; then
            echo "âœ… Release binary build successful: $TAG"
            echo "ğŸ“¦ Binary: etc_meisai_scraper-$TAG-windows-amd64.exe"

            # Create GitHub Release
            echo "ğŸ”„ Creating GitHub Release..."
            gh release create $TAG \
                etc_meisai_scraper-$TAG-windows-amd64.exe \
                --repo yhonda-ohishi-pub-dev/etc_meisai_scraper \
                --title "$TAG" \
                --notes "Release $TAG" \
                --latest

            if [ $? -eq 0 ]; then
                echo "âœ… GitHub Release created: $TAG"

                # Clean up local build files
                echo "ğŸ§¹ Cleaning up local build files..."
                rm -f etc_meisai_scraper-$TAG-windows-amd64.exe
                echo "âœ… Cleanup completed"
            else
                echo "âš ï¸  GitHub Release creation failed (continuing with git push)"
            fi
        else
            echo "âš ï¸  Release binary build failed (continuing with git push)"
        fi
    fi
done

exit 0
